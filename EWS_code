def parse_individual_risk_assessment(response_text: str) -> Dict[str, Any]:
    """Parse individual risk assessment response to extract summary and risk level"""
    
    # Extract summary
    summary_match = re.search(r'Summary:\s*(.+?)(?=Risk Level:|$)', response_text, re.DOTALL)
    summary = summary_match.group(1).strip() if summary_match else "No summary provided"
    
    # Extract risk level
    risk_level_match = re.search(r'Risk Level:\s*([^\n]+)', response_text)
    risk_level = risk_level_match.group(1).strip() if risk_level_match else "Not_Applicable"
    
    # Clean up the risk level
    risk_level = risk_level.replace('[', '').replace(']', '').strip()
    
    # Keep the full summary for now - we'll summarize it later in create_enhanced_summary
    return {
        'summary': summary,
        'risk_level': risk_level
    }

def create_enhanced_summary_with_llm(criteria_results: List[Dict], llm: AzureOpenAILLM) -> List[str]:
    """Create enhanced summary for HIGH RISK flags only with proper 2-3 line summaries using LLM"""
    
    high_risk_summaries = []
    
    for result in criteria_results:
        parsed = result.get('parsed_result', {})
        risk_level = parsed.get('risk_level', 'Not_Applicable')
        summary = parsed.get('summary', 'No summary available')
        criteria_name = result.get('criteria', 'Unknown')
        
        # Only include HIGH RISK flags
        if 'High' in risk_level and 'No' not in summary and 'Not_Applicable' not in risk_level:
            
            # Use LLM to create a proper 2-3 line summary
            summarization_prompt = f"""
You are a financial analyst. Please create a concise 2-3 line summary of the following risk assessment for {criteria_name.replace('_', ' ').title()}:

Original Assessment: {summary}

Requirements:
- Keep it to exactly 2-3 lines
- Focus on the key financial risks and their impact
- Include specific numbers/percentages if mentioned
- Make it clear and actionable for stakeholders
- Do not use bullet points, write in paragraph form

Summary:"""
            
            try:
                # Get 2-3 line summary from LLM
                enhanced_summary = llm._call(summarization_prompt, max_tokens=200, temperature=0.1)
                
                # Clean up the response
                enhanced_summary = enhanced_summary.strip()
                
                # Ensure it's not too long (backup check)
                if len(enhanced_summary) > 300:
                    lines = enhanced_summary.split('. ')
                    if len(lines) >= 2:
                        enhanced_summary = '. '.join(lines[:2]) + '.'
                    else:
                        enhanced_summary = enhanced_summary[:297] + '...'
                
                high_risk_summaries.append(enhanced_summary)
                
            except Exception as e:
                logger.error(f"Error creating enhanced summary for {criteria_name}: {e}")
                # Fallback to truncated version if LLM fails
                if len(summary) > 200:
                    sentences = summary.split('. ')
                    if len(sentences) >= 2:
                        fallback_summary = '. '.join(sentences[:2]) + '.'
                    else:
                        fallback_summary = summary[:197] + '...'
                    high_risk_summaries.append(fallback_summary)
                else:
                    high_risk_summaries.append(summary)
    
    return high_risk_summaries

def update_individual_criteria_prompts() -> Dict[str, str]:
    """Update individual criteria prompts to request better summaries"""
    
    criteria_prompts = {
        "debt_increase": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to debt increases.

Look for:
- Total debt increases compared to previous periods
- Long-term debt changes
- Borrowing increases
- Debt restructuring issues

Classification levels:
- High: Debt increase by >=40% compared to previous reported balance sheet number
- Medium: Debt increase between 25 to 40% compared to previous reported balance sheet number  
- Low: Debt increase is less than 25% compared to previous reported balance sheet number
- Not_Applicable: No debt increase red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Debt Increase Risk Assessment:**
Summary: [Detailed summary with specific figures, context, and business impact. Include what type of debt increased, by how much, reasons mentioned, and potential consequences for the business. This should be comprehensive enough to understand the full scope of the debt increase concern.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "provisioning": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to provisioning and write-offs.

Look for:
- Provisioning for bad debts
- Write-offs mentioned
- Impairment charges
- Credit loss provisions

Classification levels:
- High: Provisioning or write-offs more than 25% of current quarter's EBITDA
- Medium: Provisioning or write-offs between 10 to 25% of current quarter's EBITDA
- Low: Provisioning or write-offs less than 10% of current quarter's EBITDA
- Not_Applicable: No provisioning red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Provisioning Risk Assessment:**
Summary: [Detailed summary with specific amounts, types of provisions, reasons for write-offs, and business impact. Include what assets or receivables were affected and management's explanation for these provisions.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "asset_decline": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to asset value decline.

Look for:
- Asset value decreases
- Asset impairment
- Fixed asset write-downs
- Investment value declines

Classification levels:
- High: Asset value falls by >=40% compared to previous reported balance sheet number
- Medium: Asset value falls between 25% to 40% compared to previous reported balance sheet number
- Low: Asset value falls by less than 25% compared to previous reported balance sheet number
- Not_Applicable: No asset decline red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Asset Decline Risk Assessment:**
Summary: [Detailed summary with specific asset types affected, decline amounts/percentages, reasons for impairment, and impact on business operations. Include management's plans to address asset value concerns.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        # Continue with similar detailed prompts for all other criteria...
        "receivable_days": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to receivable days increase.

Look for:
- Receivable days increase
- Collection period extension
- Accounts receivable growth
- Customer payment delays

Classification levels:
- High: Receivable days increase by >=40% compared to previous reported balance sheet number
- Medium: Receivable days increase between 25 to 40% compared to previous reported balance sheet number
- Low: Receivable days increase is less than 25% compared to previous reported balance sheet number
- Not_Applicable: No receivable days red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Receivable Days Risk Assessment:**
Summary: [Detailed summary with current vs previous receivable days, reasons for increase, customer segments affected, and management's collection strategies. Include impact on cash flow and working capital.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "payable_days": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to payable days increase.

Look for:
- Payable days increase
- Payment period extension
- Accounts payable growth
- Supplier payment delays

Classification levels:
- High: Payable days increase by >=40% compared to previous reported balance sheet number
- Medium: Payable days increase between 25 to 40% compared to previous reported balance sheet number
- Low: Payable days increase is less than 25% compared to previous reported balance sheet number
- Not_Applicable: No payable days red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Payable Days Risk Assessment:**
Summary: [Detailed summary with current vs previous payable days, reasons for extension, supplier relationships impact, and cash flow implications. Include any supplier financing arrangements or payment term renegotiations.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "debt_ebitda": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to debt-to-EBITDA ratio.

Look for:
- Debt/EBITDA ratio mentions
- High leverage concerns
- Coverage ratio issues
- Debt serviceability problems

Classification levels:
- High: Debt/EBITDA > 4x
- Medium: Debt/EBITDA 2-4x
- Low: Debt/EBITDA < 2x
- Not_Applicable: No debt/EBITDA red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Debt EBITDA Risk Assessment:**
Summary: [Detailed summary with current debt/EBITDA ratio, trend analysis, covenant compliance status, and impact on financial flexibility. Include management's deleveraging plans and timeline.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "revenue_decline": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to revenue decline.

Look for:
- Revenue decreases
- Sales decline
- Top-line reduction
- Income statement revenue issues

Classification levels:
- High: Revenue or profitability falls by >=25% compared to previous reported quarter number
- Medium: Revenue or profitability falls between 10% to 25% compared to previous reported quarter number
- Low: Revenue or profitability falls by less than 10% compared to previous reported quarter number
- Not_Applicable: No revenue decline red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Revenue Decline Risk Assessment:**
Summary: [Detailed summary with revenue decline percentages, affected business segments, market conditions, competitive pressures, and management's recovery strategies. Include forward-looking guidance and market outlook.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "onetime_expenses": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to one-time expenses.

Look for:
- One-time charges
- Exceptional expenses
- Non-recurring costs
- Special items or extraordinary expenses

Classification levels:
- High: One-time expenses or losses more than 25% of current quarter's EBITDA
- Medium: One-time expenses or losses between 10 to 25% of current quarter's EBITDA
- Low: One-time expenses or losses less than 10% of current quarter's EBITDA
- Not_Applicable: No one-time expenses red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**One-time Expenses Risk Assessment:**
Summary: [Detailed summary with types of one-time expenses, amounts involved, reasons for these charges, and their impact on underlying business performance. Include management's explanation and whether similar charges are expected in future quarters.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "margin_decline": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to margin decline.

Look for:
- Gross margin decline
- Operating margin compression
- EBITDA margin reduction
- Profitability margin issues

Classification levels:
- High: Gross margin or operating margin falling more than 25% compared to previous reported quarter number
- Medium: Gross margin or operating margin falling between 10 to 25% compared to previous reported quarter number
- Low: Gross margin or operating margin falling less than 10% compared to previous reported quarter number
- Not_Applicable: No margin decline red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Margin Decline Risk Assessment:**
Summary: [Detailed summary with specific margin metrics affected, cost pressures, pricing power, competitive dynamics, and operational efficiency measures. Include management's margin improvement initiatives and timeline for recovery.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "cash_balance": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to cash balance decline.

Look for:
- Cash balance decreases
- Cash flow negative trends
- Liquidity reduction
- Cash position deterioration

Classification levels:
- High: Cash balance falling more than 25% compared to previous reported balance sheet number
- Medium: Cash balance falling between 10 to 25% compared to previous reported balance sheet number
- Low: Cash balance falling less than 10% compared to previous reported balance sheet number
- Not_Applicable: No cash balance red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Cash Balance Risk Assessment:**
Summary: [Detailed summary with cash position changes, cash flow generation capability, liquidity sources, and working capital management. Include management's cash preservation strategies and funding arrangements.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "short_term_debt": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to short-term debt increase.

Look for:
- Short-term debt increases
- Current liabilities growth
- Working capital issues
- Short-term borrowing increases

Classification levels:
- High: Short-term debt or current liabilities increase by >=40% compared to previous reported balance sheet number
- Medium: Short-term debt or current liabilities increase between 25 to 40% compared to previous reported balance sheet number
- Low: Short-term debt or current liabilities increase is less than 25% compared to previous reported balance sheet number
- Not_Applicable: No short-term debt red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Short-term Debt Risk Assessment:**
Summary: [Detailed summary with short-term debt components, maturity profile, refinancing requirements, and liquidity planning. Include management's approach to managing near-term obligations and available credit facilities.]
Risk Level: [High/Medium/Low/Not_Applicable]
""",

        "management_issues": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to management and leadership issues.

Look for:
- Management turnover
- Key personnel departures
- Leadership changes
- Governance issues
- Strategic execution problems

Classification levels:
- High: Any management turnover or key personnel departures, Poor track record of execution or delivery, High employee attrition rates
- Low: No management turnover or key personnel departures, Strong track record of execution or delivery, Low employee attrition rates
- Not_Applicable: No management issues red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Management Issues Risk Assessment:**
Summary: [Detailed summary with specific management changes, roles affected, succession planning, governance concerns, and impact on business continuity. Include board composition changes and strategic direction consistency.]
Risk Level: [High/Low/Not_Applicable]
""",

        "regulatory_compliance": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to regulatory compliance.

Look for:
- Regulatory violations
- Compliance issues
- Legal problems
- Regulatory warnings or penalties

Classification levels:
- High: If found any regulatory issues as a concern or a conclusion of any discussion related to regulatory issues or warning(s) from the regulators
- Low: If there is no clear concern for the company based on the discussion on the regulatory issues
- Not_Applicable: No regulatory compliance red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Regulatory Compliance Risk Assessment:**
Summary: [Detailed summary with specific regulatory bodies involved, nature of compliance issues, penalties or warnings, remediation measures, and potential business impact. Include management's compliance strengthening initiatives.]
Risk Level: [High/Low/Not_Applicable]
""",

        "market_competition": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to market competition.

Look for:
- Competitive pressure
- Market share loss
- New competitors entering
- Industry competition intensifying

Classification levels:
- High: Any competitive intensity or new entrants, Any decline in market share
- Low: Low competitive intensity or new entrants, Stable or increasing market share
- Not_Applicable: No market competition red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Market Competition Risk Assessment:**
Summary: [Detailed summary with competitive landscape changes, market share trends, pricing pressures, new entrant impact, and strategic responses. Include management's competitive positioning strategy and differentiation factors.]
Risk Level: [High/Low/Not_Applicable]
""",

        "operational_disruptions": """
Based on the deduplicated red flags analysis, evaluate if there are any red flags specifically related to operational disruptions.

Look for:
- Supply chain disruptions
- Production issues
- IT system failures
- Operational inefficiencies
- Infrastructure problems

Classification levels:
- High: If found any operational or supply chain issues as a concern or a conclusion of any discussion related to operational issues
- Low: If there is no clear concern for the company based on the discussion on the operational or supply chain issues
- Not_Applicable: No operational disruption red flags found

Provide a comprehensive summary with specific details, numbers, and context.

Format:
**Operational Disruptions Risk Assessment:**
Summary: [Detailed summary with specific operational challenges, supply chain disruptions, system issues, efficiency improvements needed, and business continuity measures. Include management's operational excellence initiatives and recovery timelines.]
Risk Level: [High/Low/Not_Applicable]
"""
    }
    
    return criteria_prompts
